<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Boat Racer - Quests Update</title>
<style>
  html, body {
    margin:0; padding:0; overflow:hidden; 
    background: #0a192f;
    font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
    user-select:none; touch-action:none;
    color:#00fff7;
    height: 100%;
  }
  body, #mainContent {
    height: 100%;
    width: 100%;
    overflow: hidden;
  }
  body::before {
    content: "";
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: 
      radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 1px, transparent 1px),
      radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 50px 50px;
    z-index: -1;
  }
  #info {
    position: fixed; top: 10px; left: 10px; right:10px; height: 50px;
    display: flex; align-items: center; justify-content: space-around;
    font-weight: bold; font-size: 20px;
    text-shadow: 0 0 8px #00fff7;
    pointer-events: none;
    z-index: 100;
  }
  #hearts {
    flex: 0 0 140px;
    display: flex;
    justify-content: space-between;
  }
  .heart {
    width: 28px;
    height: 28px;
    background: red;
    clip-path: polygon(
      50% 15%, 61% 10%, 75% 15%, 85% 27%, 85% 40%, 75% 55%,
      50% 80%, 25% 55%, 15% 40%, 15% 27%, 25% 15%, 39% 10%
    );
    filter: drop-shadow(0 0 5px #ff4d4d);
  }
  .heart.lost {
    background: #400000;
    filter: none;
  }
  button {
    background:#4AA1B0;
    border:none;
    color:#fff;
    font-weight:bold;
    font-size: 18px;
    padding: 10px 25px;
    margin: 10px;
    border-radius: 7px;
    cursor: pointer;
    box-shadow: 0 0 10px #4AA1B0;
    transition: all 0.3s ease;
  }
  button:hover {
    background:#73c2e9;
    box-shadow: 0 0 14px #73c2e9;
    transform: translateY(-3px);
  }
  #menu, #skinsMenu, #restartMenu, #pauseMenu, #difficultyMenu, #questsMenu {
    position: fixed;
    top:50%; left:50%;
    transform: translate(-50%, -50%);
    background: rgba(20,20,40,0.95);
    border-radius: 15px;
    padding: 30px 40px;
    text-align: center;
    box-shadow: 0 0 30px #00fff7;
    color: #00fff7;
    display: none;
    min-width: 280px;
    user-select:none;
    z-index: 200;
  }
  #difficultyMenu h1, #questsMenu h2 {
    margin-top: 0;
    font-size: 2.5em;
    text-shadow: 0 0 10px #00fff7;
    margin-bottom: 30px;
  }
  .difficulty-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 20px 0;
    padding: 15px;
    border-radius: 10px;
    background: rgba(0, 100, 150, 0.3);
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .difficulty-option:hover {
    background: rgba(0, 150, 200, 0.4);
    transform: scale(1.05);
  }
  .difficulty-option.selected {
    background: rgba(0, 200, 255, 0.4);
    box-shadow: 0 0 15px #00fff7;
    transform: scale(1.05);
  }
  .difficulty-title {
    font-size: 1.8em;
    font-weight: bold;
    margin-bottom: 10px;
    text-shadow: 0 0 8px currentColor;
  }
  .difficulty-description {
    font-size: 0.9em;
    max-width: 300px;
    color: #aaf;
  }
  .difficulty-easy .difficulty-title { color: #7cff7c; }
  .difficulty-hard .difficulty-title { color: #ff6b6b; }
  #skinsMenu button.skin-btn {
    margin: 5px;
    width: 50px; height: 50px;
    border-radius: 50%;
    border: 2px solid #00fff7;
  }
  #skinsMenu button.skin-btn.selected {
    box-shadow: 0 0 15px 3px #00fff7;
  }
  #questsMenu {
    min-width: 310px;
    padding: 30px 32px;
  }
  .quest {
    margin: 16px 0;
    padding: 10px;
    border-radius: 10px;
    background: rgba(0,100,150,0.3);
    font-size: 1.1em;
    box-shadow: 0 0 8px #0ff5;
    transition: all 0.3s;
  }
  .quest.completed {
    background: rgba(0,200,100,0.28);
    filter: drop-shadow(0 0 8px #7cff7c);
  }
  canvas {
    display:block; margin:0 auto;
    background: transparent;
  }
  #flashOverlay {
    position: fixed;
    top:0; left:0; width: 100vw; height: 100vh;
    pointer-events:none;
    background: rgba(255,0,0,0.4);
    display: none;
    mix-blend-mode: screen;
    z-index: 1000;
  }
  #pauseBtn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(74, 161, 176, 0.7);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 0 10px #4AA1B0;
    z-index: 100;
    display: none;
  }
  #pauseBtn:hover {
    background: rgba(115, 194, 233, 0.7);
    box-shadow: 0 0 14px #73c2e9;
  }
  .power-up-indicator {
    position: fixed;
    bottom: 80px;
    left: 20px;
    display: flex;
    gap: 10px;
  }
  .power-up-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px black;
  }
  .power-up-icon.active {
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 10px white;
  }
  .power-up-icon.shield { background: rgba(0, 200, 255, 0.7); }
  .power-up-icon.slow { background: rgba(255, 100, 0, 0.7); }
  .power-up-icon.speed { background: rgba(0, 255, 100, 0.7); }
  #difficultyIndicator {
    position: fixed;
    top: 70px;
    right: 20px;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
    background: rgba(0, 0, 0, 0.5);
    box-shadow: 0 0 8px currentColor;
    z-index: 100;
    display: none;
  }
  #difficultyIndicator.easy { color: #7cff7c; }
  #difficultyIndicator.hard { color: #ff6b6b; }
  #adBanner {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 60px;
    background: #191919;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 5000;
    box-shadow: 0 -2px 16px #000a;
  }
</style>
</head>
<body>
<div id="mainContent">
  <div id="info">
    <div id="hearts"></div>
    <div id="time">Time: 0s</div>
    <div id="highScore">High Score: 0s</div>
  </div>
  <div id="difficultyIndicator"></div>
  <div id="menu">
    <h1>Boat Racer</h1>
    <button id="playBtn">Play</button><br/>
    <button id="skinsBtn">Skins</button><br/>
    <button id="questsBtn">Quests</button><br/>
  </div>
  <div id="difficultyMenu">
    <h1>Select Difficulty</h1>
    <div class="difficulty-option difficulty-easy" data-difficulty="easy">
      <div class="difficulty-title">Easy Mode</div>
      <div class="difficulty-description">Gentle pace, fewer obstacles - perfect for beginners</div>
    </div>
    <div class="difficulty-option difficulty-hard" data-difficulty="hard">
      <div class="difficulty-title">Hard Mode</div>
      <div class="difficulty-description">High speed, more obstacles - for the true daredevils!</div>
    </div>
    <button id="startGameBtn">Start Game</button>
  </div>
  <div id="skinsMenu">
    <h2>Select Your Boat Skin</h2>
    <div id="skinOptions"></div>
    <button id="skinsBackBtn">Back</button>
  </div>
  <div id="questsMenu">
    <h2>Quests</h2>
    <div id="questList"></div>
    <button id="questsBackBtn">Back</button>
  </div>
  <div id="restartMenu">
    <h1>Game Over!</h1>
    <p id="finalScore">Your Time: 0s</p>
    <p id="bestScore">Best Time: 0s</p>
    <button id="restartBtn">Restart</button><br/>
    <button id="backToMenuBtn">Main Menu</button>
  </div>
  <div id="pauseMenu">
    <h1>Game Paused</h1>
    <button id="continueBtn">Continue</button><br/>
    <button id="pauseToMenuBtn">Main Menu</button>
  </div>
  <div id="flashOverlay"></div>
  <button id="pauseBtn">‚è∏</button>
  <div class="power-up-indicator">
    <div class="power-up-icon shield" title="Shield">üõ°Ô∏è</div>
    <div class="power-up-icon slow" title="Slow Motion">üêå</div>
    <div class="power-up-icon speed" title="Health Boost">‚ù§Ô∏è</div>
  </div>
  <canvas id="gameCanvas"></canvas>
</div>

<!-- Ad Banner along the bottom -->
<div id="adBanner">
  <script type="text/javascript">
    atOptions = {
      'key' : 'd8c18047f4719cbcbd612bf296c3aa34',
      'format' : 'iframe',
      'height' : 50,
      'width' : 320,
      'params' : {}
    };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/d8c18047f4719cbcbd612bf296c3aa34/invoke.js"></script>
</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  function resize(){
    const adBanner = document.getElementById('adBanner');
    const adHeight = adBanner ? adBanner.offsetHeight : 0;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - adHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  const infoTime = document.getElementById('time');
  const infoHighScore = document.getElementById('highScore');
  const heartsContainer = document.getElementById('hearts');
  const menu = document.getElementById('menu');
  const playBtn = document.getElementById('playBtn');
  const skinsBtn = document.getElementById('skinsBtn');
  const skinsMenu = document.getElementById('skinsMenu');
  const skinOptionsDiv = document.getElementById('skinOptions');
  const skinsBackBtn = document.getElementById('skinsBackBtn');
  const restartMenu = document.getElementById('restartMenu');
  const finalScoreP = document.getElementById('finalScore');
  const bestScoreP = document.getElementById('bestScore');
  const restartBtn = document.getElementById('restartBtn');
  const backToMenuBtn = document.getElementById('backToMenuBtn');
  const flashOverlay = document.getElementById('flashOverlay');
  const pauseBtn = document.getElementById('pauseBtn');
  const pauseMenu = document.getElementById('pauseMenu');
  const continueBtn = document.getElementById('continueBtn');
  const pauseToMenuBtn = document.getElementById('pauseToMenuBtn');
  const powerUpIndicators = document.querySelectorAll('.power-up-icon');
  const difficultyMenu = document.getElementById('difficultyMenu');
  const startGameBtn = document.getElementById('startGameBtn');
  const difficultyOptions = document.querySelectorAll('.difficulty-option');
  const difficultyIndicator = document.getElementById('difficultyIndicator');

  // QUEST System DOM
  const questsBtn = document.getElementById('questsBtn');
  const questsMenu = document.getElementById('questsMenu');
  const questsBackBtn = document.getElementById('questsBackBtn');
  const questList = document.getElementById('questList');

  let lives = 3;
  const maxLives = 3;
  let distance = 0;
  let startTime = 0;
  let gameOver = false;
  let obstacles = [];
  let powerUps = [];
  let lastSpawn = 0;
  let spawnInterval = 2500;
  let difficultyIncreaseInterval = 30000;
  let lastDifficultyIncrease = 0;
  let obstacleSpeed = 2.5;
  let maxObstacles = 3;
  let difficulty = 'easy';
  let powerUpSpawnChance = 0.006;
  const powerUpTypeChances = { shield: 0.4, slow: 0.4, speed: 0.2 };
  let flashing = false;
  let flashTime = 0;
  let flashDuration = 300;
  let highScore = 0;
  let gamePaused = false;
  let pauseTime = 0;
  let pauseDuration = 0;
  let hasShield = false;
  let slowMotionActive = false;
  let powerUpEndTime = { slow: 0 };
  const powerUpDuration = 5000;

  // Boat Skins (can be plain color or gradient type)
  let boatSkins = [
    {color: '#E63946', name: 'Red'},
    {color: '#457B9D', name: 'Blue'},
    {color: '#2A9D8F', name: 'Teal'},
    {color: '#F4A261', name: 'Orange'},
    {color: '#6A4C93', name: 'Purple'}
  ];
  let currentSkinIndex = 0;

  // Load saved skins
  if(localStorage.getItem("boatRacerSkins")){
    let saved = JSON.parse(localStorage.getItem("boatRacerSkins"));
    if(saved.length > boatSkins.length)
      boatSkins = saved;
  }

  const boat = {
    w: 60,
    h: 90,
    x: 0,
    y: 0,
    speed: 6,
    baseSpeed: 6,
    color: boatSkins[0].color
  };

  function resetBoat(){
    boat.x = canvas.width/2 - boat.w/2;
    boat.y = canvas.height - boat.h - 100;
    boat.color = boatSkins[currentSkinIndex].color;
    boat.speed = boat.baseSpeed;
  }

  // QUEST definitions and storage
  const quests = [
    {
      id: 'survive60',
      description: "Survive 60s in one run",
      progress: 0, // not needed for this type
      goal: 60,
      reward: { type: 'skin', color: '#7bbc97', name: 'Camo Boat' },
      completed: false
    },
    {
      id: 'powerup10',
      description: "Collect 10 power-ups (lifetime)",
      progress: 0,
      goal: 10,
      reward: { type: 'skin', color: '#39FF14', name: 'Neon Boat' },
      completed: false
    },
    {
      id: 'beatBest',
      description: "Beat your best score by +30s",
      progress: 0, // dummy, not used
      goal: 1,
      reward: { type: 'skin', rainbow:true, name: 'Rainbow Boat' },
      completed: false
    }
  ];

  // Load quest progress
  let questProgress = JSON.parse(localStorage.getItem("boatRacerQuests") || "{}");
  quests.forEach(q=>{
    if(questProgress[q.id]) Object.assign(q, questProgress[q.id]);
  });

  function saveQuests(){
    const data = {};
    quests.forEach(q => data[q.id] = q);
    localStorage.setItem("boatRacerQuests", JSON.stringify(data));
  }
  function saveSkins(){
    localStorage.setItem("boatRacerSkins", JSON.stringify(boatSkins));
  }

  function renderQuests(){
    questList.innerHTML = "";
    quests.forEach(q=>{
      const div = document.createElement('div');
      div.className = `quest${q.completed ? ' completed' : ''}`;
      let progText = q.completed ?
        "‚úÖ Completed!" :
        (q.id==='survive60'||q.id==='beatBest' ? "Progress: -" : `Progress: ${q.progress}/${q.goal}`);
      let rewardText = q.reward.name || 'Unknown';
      div.innerHTML = `<b>${q.description}</b><br/>${progText}<br/>Reward: <i>${rewardText}</i>`;
      questList.appendChild(div);
    });
  }
  questsBtn.addEventListener("click", () => {
    renderQuests();
    showQuestsMenu();
  });
  questsBackBtn.addEventListener("click", showMainMenu);

  function showQuestsMenu(){
    menu.style.display = 'none';
    questsMenu.style.display = 'block';
    skinsMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
  }

  // Touch input with dragging fix
  let dragging = false;
  let touchOffsetX = 0;

  canvas.addEventListener("touchstart", e => {
    const touch = e.touches[0];
    if (
      touch.clientX >= boat.x &&
      touch.clientX <= boat.x + boat.w &&
      touch.clientY >= boat.y &&
      touch.clientY <= boat.y + boat.h
    ) {
      dragging = true;
      touchOffsetX = touch.clientX - boat.x;
    }
  }, { passive: false });
  canvas.addEventListener("touchmove", e => {
    if (!dragging) return;
    const touch = e.touches[0];
    boat.x = touch.clientX - touchOffsetX;
    boat.x = Math.min(Math.max(0, boat.x), canvas.width - boat.w);
  }, { passive: false });
  canvas.addEventListener("touchend", () => {
    dragging = false;
  });

  // Keyboard control fallback
  let keys = {};
  window.addEventListener('keydown', e => { 
    keys[e.key] = true; 
    if(e.key === 'Escape') togglePause();
  });
  window.addEventListener('keyup', e => { keys[e.key] = false; });

  // Classes for PowerUp and Obstacle
  class PowerUp {
    constructor(type, x, y) {
      this.type = type;
      this.x = x;
      this.y = y;
      this.size = 30;
      this.speed = 2;
      this.collected = false;
      switch(type) {
        case 'shield':
          this.color = '#00a8ff';
          this.symbol = 'üõ°Ô∏è';
          break;
        case 'slow':
          this.color = '#fbc531';
          this.symbol = 'üêå';
          break;
        case 'speed':
          this.color = '#4cd137';
          this.symbol = '‚ù§Ô∏è';
          break;
      }
    }
    update() { this.y += this.speed; }
    draw() {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.beginPath();
      ctx.arc(0, 0, this.size/2, 0, Math.PI * 2);
      ctx.fillStyle = this.color;
      ctx.fill();
      ctx.beginPath();
      ctx.arc(0, 0, this.size/2 - 5, 0, Math.PI * 2);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = this.color;
      ctx.fillText(this.symbol, 0, 0);
      ctx.restore();
    }
    getBounds() {
      return {
        x: this.x - this.size/2,
        y: this.y - this.size/2,
        width: this.size,
        height: this.size
      };
    }
    activate() {
      this.collected = true;
      const now = Date.now();
      switch(this.type) {
        case 'shield':
          hasShield = true;
          updatePowerUpIndicators();
          break;
        case 'slow':
          slowMotionActive = true;
          powerUpEndTime.slow = now + powerUpDuration;
          break;
        case 'speed':
          if (lives < maxLives) {
            lives++;
            updateHearts();
          }
          break;
      }
      updatePowerUpIndicators();
    }
  }

  class Obstacle {
    constructor(x, y, speed){
      this.x = x;
      this.y = y;
      this.speed = speed;
      this.size = 20 + Math.random()*30;
      const shapes = ['circle', 'square', 'triangle'];
      this.shape = shapes[Math.floor(Math.random()*shapes.length)];
      const colors = ['#FFD166', '#06D6A0', '#118AB2', '#EF476F', '#FFC43D', '#8338EC'];
      this.color = colors[Math.floor(Math.random()*colors.length)];
      this.angle = 0;
      this.rotationSpeed = (Math.random() - 0.5) * 0.05;
      this.movementPattern = Math.random() > 0.7 ? (Math.random() > 0.5 ? 'zigzag' : 'following') : 'normal';
      this.zigzagSpeed = Math.random() * 2 + 1;
      this.zigzagDirection = Math.random() > 0.5 ? 1 : -1;
      this.followSpeed = Math.random() * 0.5 + 0.5;
      this.followDelay = Math.random() * 1000 + 500;
      this.followStartTime = Date.now() + this.followDelay;
    }
    update(){
      const effectiveSpeed = slowMotionActive ? this.speed * 0.3 : this.speed;
      this.y += effectiveSpeed;
      this.angle += this.rotationSpeed;
      switch(this.movementPattern) {
        case 'zigzag':
          this.x += this.zigzagSpeed * this.zigzagDirection;
          if(this.x < this.size/2 || this.x > canvas.width - this.size/2) {
            this.zigzagDirection *= -1;
          }
          break;
        case 'following':
          if(Date.now() > this.followStartTime) {
            const dx = boat.x + boat.w/2 - this.x;
            this.x += Math.sign(dx) * this.followSpeed;
          }
          break;
      }
    }
    draw(){
      ctx.fillStyle = this.color;
      ctx.save();
      ctx.translate(this.x, this.y);
      if(this.shape === 'circle'){
        ctx.beginPath();
        ctx.arc(0, 0, this.size/2, 0, 2*Math.PI);
        ctx.fill();
      } else if(this.shape === 'square'){
        ctx.rotate(this.angle);
        ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
      } else if(this.shape === 'triangle'){
        ctx.rotate(this.angle);
        ctx.beginPath();
        ctx.moveTo(0, -this.size/2);
        ctx.lineTo(this.size/2, this.size/2);
        ctx.lineTo(-this.size/2, this.size/2);
        ctx.closePath();
        ctx.fill();
      }
      if(this.movementPattern !== 'normal') {
        ctx.beginPath();
        ctx.arc(0, 0, this.size/2 + 5, 0, Math.PI * 2);
        ctx.strokeStyle = this.movementPattern === 'zigzag' ? '#f39c12' : '#e74c3c';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      ctx.restore();
    }
    getBounds(){
      return {
        x: this.x - this.size/2,
        y: this.y - this.size/2,
        width: this.size,
        height: this.size
      };
    }
  }

  function isCollide(b, o){
    return !(b.x > o.x+o.width || b.x+b.w < o.x || b.y > o.y+o.height || b.y+b.h < o.y);
  }

  function drawBoat(){
    ctx.save();
    ctx.translate(boat.x + boat.w/2, boat.y + boat.h/2);
    const angle = Math.sin(Date.now()/300) * 0.1;
    ctx.rotate(angle);
    if(hasShield) {
      ctx.beginPath();
      ctx.arc(0, 0, Math.max(boat.w, boat.h)/2 + 10, 0, Math.PI * 2);
      ctx.strokeStyle = '#00a8ff';
      ctx.lineWidth = 3;
      ctx.setLineDash([5, 5]);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    // Rainbow boat drawing
    if(boatSkins[currentSkinIndex].rainbow){
      let grad = ctx.createLinearGradient(-boat.w/2, 0, boat.w/2, 0);
      grad.addColorStop(0, "red");
      grad.addColorStop(0.2, "orange");
      grad.addColorStop(0.4, "yellow");
      grad.addColorStop(0.6, "green");
      grad.addColorStop(0.8, "blue");
      grad.addColorStop(1, "purple");
      ctx.fillStyle = grad;
    } else {
      ctx.fillStyle = boat.color;
    }
    ctx.beginPath();
    ctx.moveTo(-boat.w/2, boat.h/2);
    ctx.lineTo(-boat.w/3, -boat.h/2);
    ctx.lineTo(boat.w/3, -boat.h/2);
    ctx.lineTo(boat.w/2, boat.h/2);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle = '#00fff7';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(-boat.w/4, boat.h/3);
    ctx.lineTo(boat.w/4, boat.h/3);
    ctx.stroke();
    ctx.fillStyle = '#0ff';
    ctx.fillRect(-boat.w/10, boat.h/6, boat.w/5, boat.h/12);
    ctx.restore();
  }

  function updateHearts(){
    heartsContainer.innerHTML = '';
    for(let i=0; i<maxLives; i++){
      const heart = document.createElement('div');
      heart.classList.add('heart');
      if(i >= lives) heart.classList.add('lost');
      heartsContainer.appendChild(heart);
    }
  }
  function triggerFlash(){
    flashing = true;
    flashTime = Date.now();
    flashOverlay.style.display = 'block';
  }
  function updateFlash(){
    if(flashing && Date.now() - flashTime > flashDuration){
      flashing = false;
      flashOverlay.style.display = 'none';
    }
  }
  function updatePowerUpIndicators() {
    const now = Date.now();
    powerUpIndicators[0].classList.toggle('active', hasShield);
    powerUpIndicators[1].classList.toggle('active', slowMotionActive && now < powerUpEndTime.slow);
    powerUpIndicators[2].classList.toggle('active', false);
  }
  function checkPowerUpExpiration() {
    const now = Date.now();
    if(slowMotionActive && now > powerUpEndTime.slow) {
      slowMotionActive = false;
    }
    updatePowerUpIndicators();
  }
  function spawnPowerUp() {
    if(Math.random() < powerUpSpawnChance && powerUps.length < 1) {
      const rand = Math.random();
      let type;
      if (rand < powerUpTypeChances.shield) type = 'shield';
      else if (rand < powerUpTypeChances.shield + powerUpTypeChances.slow) type = 'slow';
      else type = 'speed';
      const x = Math.random() * (canvas.width - 60) + 30;
      powerUps.push(new PowerUp(type, x, -50));
    }
  }
  function increaseDifficulty() {
    spawnInterval = Math.max(800, spawnInterval - 100);
    obstacleSpeed += 0.3;
    maxObstacles = Math.min(8, maxObstacles + 1);
    powerUpSpawnChance = Math.min(0.015, powerUpSpawnChance + 0.001);
  }

  // PAUSE / RESUME fix for correct pause duration tracking & prevent negative time
  function togglePause(){
    if(gameOver) return;
    if(!gamePaused) {
      // Pausing now
      pauseTime = Date.now();
      gamePaused = true;
      cancelAnimationFrame(animationFrameId);
      pauseMenu.style.display = 'block';
      pauseBtn.textContent = '‚ñ∂';
    } else {
      // Resuming now
      pauseDuration += (Date.now() - pauseTime);
      pauseTime = 0;
      gamePaused = false;
      pauseMenu.style.display = 'none';
      pauseBtn.textContent = '‚è∏';
      loop();
    }
  }

  let animationFrameId;

  function resetGame(){
    lives = maxLives;
    distance = 0;
    startTime = Date.now();
    gameOver = false;
    obstacles = [];
    powerUps = [];
    lastSpawn = 0;
    lastDifficultyIncrease = 0;
    if (difficulty === 'hard') {
      spawnInterval = 1800;
      obstacleSpeed = 4.0;
      maxObstacles = 5;
      powerUpSpawnChance = 0.008;
      difficultyIndicator.textContent = "HARD MODE";
      difficultyIndicator.className = "hard";
    }
    else {
      spawnInterval = 2500;
      obstacleSpeed = 2.5;
      maxObstacles = 3;
      powerUpSpawnChance = 0.006;
      difficultyIndicator.textContent = "EASY MODE";
      difficultyIndicator.className = "easy";
    }
    difficultyIndicator.style.display = 'block';
    pauseDuration = 0;
    hasShield = false;
    slowMotionActive = false;
    boat.speed = boat.baseSpeed;
    gamePaused = false; // Game starts unpaused
    updatePowerUpIndicators();
    resetBoat();
    updateHearts();
    updateInfo();
  }

  function updateInfo(){
    let elapsed = Math.floor((Date.now() - startTime - pauseDuration) / 1000);
    if(elapsed < 0) elapsed = 0; // Prevent negative time
    infoTime.textContent = `Time: ${elapsed}s`;
    if(elapsed > highScore) {
      highScore = elapsed;
      localStorage.setItem('boatRacerHighScore', highScore);
    }
    infoHighScore.textContent = `High Score: ${highScore}s`;
  }

  function spawnObstacle(){
    const x = Math.random() * (canvas.width - 60) + 30;
    obstacles.push(new Obstacle(x, -50, obstacleSpeed));
  }

  function update(){
    if(gameOver || gamePaused) return;
    const now = Date.now();
    if(now - lastSpawn > spawnInterval && obstacles.length < maxObstacles){
      lastSpawn = now;
      spawnObstacle();
    }
    spawnPowerUp();
    if(now - lastDifficultyIncrease > difficultyIncreaseInterval){
      lastDifficultyIncrease = now;
      increaseDifficulty();
    }
    obstacles.forEach((o, i) => {
      o.update();
      if(o.y - o.size/2 > canvas.height){
        obstacles.splice(i, 1);
        distance += 100;
      } else if(isCollide(boat, o.getBounds())){
        obstacles.splice(i, 1);
        if(hasShield) {
          hasShield = false;
          updatePowerUpIndicators();
        } else {
          lives--;
          updateHearts();
          triggerFlash();
          if(lives <= 0) {
            gameOver = true;
            cancelAnimationFrame(animationFrameId);
            showRestartMenu();
          }
        }
      }
    });
    powerUps.forEach((p, i) => {
      p.update();
      if(p.y - p.size/2 > canvas.height) {
        powerUps.splice(i, 1);
      } else if(!p.collected && isCollide(boat, p.getBounds())) {
        p.activate();
        powerUps.splice(i, 1);
        onPowerupCollected(); // QUEST PROGRESS
      }
    });
    checkPowerUpExpiration();
    // Move boat by keyboard if not dragging
    if (!dragging) {
      if(keys['ArrowLeft'] || keys['a']) boat.x -= boat.speed;
      if(keys['ArrowRight'] || keys['d']) boat.x += boat.speed;
      boat.x = Math.min(Math.max(0, boat.x), canvas.width - boat.w);
    }
    updateFlash();
    updateInfo();
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBoat();
    obstacles.forEach(o => o.draw());
    powerUps.forEach(p => p.draw());
  }

  function loop(){
    update();
    draw();
    if(!gameOver && !gamePaused) animationFrameId = requestAnimationFrame(loop);
  }

  // === FIX: stop game loop on returning to menu to avoid background running ===
  function showMainMenu(){
    gamePaused = true;                    // pause game loop
    cancelAnimationFrame(animationFrameId);  // cancel animation loop
    menu.style.display = 'block';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    flashOverlay.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
    pauseBtn.textContent = '‚è∏';          // reset pause button text
  }
  function showSkinsMenu(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'block';
    questsMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
  }
  function showDifficultyMenu(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'block';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
    difficultyOptions.forEach(opt => opt.classList.remove('selected'));
    difficultyOptions[0].classList.add('selected');
    difficulty = 'easy';
  }
  function showRestartMenu(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    restartMenu.style.display = 'block';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    flashOverlay.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
    const elapsed = Math.floor((Date.now()-startTime - pauseDuration)/1000);
    finalScoreP.textContent = `Your Time: ${elapsed}s`;
    bestScoreP.textContent = `Best Time: ${highScore}s`;
    checkQuestsAtEnd(elapsed); // Check quests at end of round!
  }
  function showGameCanvas(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'block';
    pauseBtn.style.display = 'block';
    difficultyIndicator.style.display = 'block';
  }

  function initSkinButtons(){
    skinOptionsDiv.innerHTML = '';
    boatSkins.forEach((skin, idx) => {
      const btn = document.createElement('button');
      btn.classList.add('skin-btn');
      if(skin.rainbow){
        btn.style.background="linear-gradient(90deg, red, orange, yellow, green, blue, purple)";
      } else {
        btn.style.background = skin.color;
      }
      if(idx === currentSkinIndex) btn.classList.add('selected');
      btn.title = skin.name;
      btn.addEventListener('click', () => {
        currentSkinIndex = idx;
        skinOptionsDiv.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        boat.color = skin.color;
        resetBoat();
      });
      skinOptionsDiv.appendChild(btn);
    });
  }

  playBtn.addEventListener('click', () => {
    showDifficultyMenu();
  });
  difficultyOptions.forEach(option => {
    option.addEventListener('click', () => {
      difficultyOptions.forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      difficulty = option.dataset.difficulty;
    });
  });
  startGameBtn.addEventListener('click', () => {
    resetGame();
    showGameCanvas();
    loop(); // Start the game loop immediately
  });
  skinsBtn.addEventListener('click', () => {
    initSkinButtons();
    showSkinsMenu();
  });
  skinsBackBtn.addEventListener('click', () => {
    showMainMenu();
  });
  restartBtn.addEventListener('click', () => {
    resetGame();
    showGameCanvas();
    loop(); // Start the game loop immediately
  });
  backToMenuBtn.addEventListener('click', () => {
    showMainMenu();
  });
  pauseBtn.addEventListener('click', togglePause);
  continueBtn.addEventListener('click', togglePause);
  pauseToMenuBtn.addEventListener('click', () => {
    togglePause();
    showMainMenu();
  });

  // QUEST SYSTEM tracking and rewards
  function checkQuestsAtEnd(elapsed){
    quests.forEach(q=>{
      if(q.id === 'survive60' && !q.completed && elapsed >= 60){
        q.completed = true;
        unlockSkin(q.reward);
      }
      if(q.id === 'beatBest' && !q.completed && elapsed >= highScore+30 && highScore>0){
        q.completed = true;
        unlockSkin(q.reward);
      }
    });
    saveQuests();
  }
  function onPowerupCollected(){
    const q = quests.find(q=>q.id==='powerup10');
    if(!q.completed){
      q.progress++;
      if(q.progress >= q.goal){
        q.completed = true;
        unlockSkin(q.reward);
      }
      saveQuests();
    }
  }
  function unlockSkin(reward){
    alert(`üéâ Quest Complete! You unlocked: ${reward.name}`);
    boatSkins.push({color: reward.color, name: reward.name, rainbow: reward.rainbow});
    saveSkins();
  }

  // AUTO-PAUSE WHEN TAB OR APP BECOMES HIDDEN
  document.addEventListener('visibilitychange', () => {
    if(document.hidden){
      if(!gamePaused && !gameOver){
        togglePause();
      }
    }
  });

  if(localStorage.getItem('boatRacerHighScore')) {
    highScore = parseInt(localStorage.getItem('boatRacerHighScore'));
    infoHighScore.textContent = `High Score: ${highScore}s`;
  }
  showMainMenu();
})();
</script>
</body>
</html>