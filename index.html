<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Boat Racer - Enhanced Quests & Shop</title>
<style>
  html, body {
    margin:0; padding:0; overflow:hidden; 
    background: #0a192f;
    font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
    user-select:none; touch-action:none;
    color:#00fff7;
    height: 100%;
  }
  body, #mainContent {
    height: 100%;
    width: 100%;
    overflow: hidden;
  }
  body::before {
    content: "";
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: 
      radial-gradient(circle at 20% 30%, rgba(255,255,255,0.1) 1px, transparent 1px),
      radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 50px 50px;
    z-index: -1;
  }
  #info {
    position: fixed; top: 10px; left: 10px; right:10px; height: 50px;
    display: flex; align-items: center; justify-content: space-around;
    font-weight: bold; font-size: 20px;
    text-shadow: 0 0 8px #00fff7;
    pointer-events: none;
    z-index: 100;
  }
  #hearts {
    flex: 0 0 140px;
    display: flex;
    justify-content: space-between;
  }
  .heart {
    width: 28px;
    height: 28px;
    background: red;
    clip-path: polygon(
      50% 15%, 61% 10%, 75% 15%, 85% 27%, 85% 40%, 75% 55%,
      50% 80%, 25% 55%, 15% 40%, 15% 27%, 25% 15%, 39% 10%
    );
    filter: drop-shadow(0 0 5px #ff4d4d);
  }
  .heart.lost {
    background: #400000;
    filter: none;
  }
  button {
    background:#4AA1B0;
    border:none;
    color:#fff;
    font-weight:bold;
    font-size: 18px;
    padding: 10px 25px;
    margin: 10px;
    border-radius: 7px;
    cursor: pointer;
    box-shadow: 0 0 10px #4AA1B0;
    transition: all 0.3s ease;
  }
  button:hover {
    background:#73c2e9;
    box-shadow: 0 0 14px #73c2e9;
    transform: translateY(-3px);
  }
  #menu, #skinsMenu, #restartMenu, #pauseMenu, #difficultyMenu, #questsMenu, #shopMenu {
    position: fixed;
    top:50%; left:50%;
    transform: translate(-50%, -50%);
    background: rgba(20,20,40,0.95);
    border-radius: 15px;
    padding: 30px 40px;
    text-align: center;
    box-shadow: 0 0 30px #00fff7;
    color: #00fff7;
    display: none;
    min-width: 280px;
    user-select:none;
    z-index: 200;
  }
  #difficultyMenu h1, #questsMenu h2, #shopMenu h2 {
    margin-top: 0;
    font-size: 2.5em;
    text-shadow: 0 0 10px #00fff7;
    margin-bottom: 30px;
  }
  .difficulty-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 20px 0;
    padding: 15px;
    border-radius: 10px;
    background: rgba(0, 100, 150, 0.3);
    transition: all 0.3s ease;
    cursor: pointer;
  }
  .difficulty-option:hover {
    background: rgba(0, 150, 200, 0.4);
    transform: scale(1.05);
  }
  .difficulty-option.selected {
    background: rgba(0, 200, 255, 0.4);
    box-shadow: 0 0 15px #00fff7;
    transform: scale(1.05);
  }
  .difficulty-title {
    font-size: 1.8em;
    font-weight: bold;
    margin-bottom: 10px;
    text-shadow: 0 0 8px currentColor;
  }
  .difficulty-description {
    font-size: 0.9em;
    max-width: 300px;
    color: #aaf;
  }
  .difficulty-easy .difficulty-title { color: #7cff7c; }
  .difficulty-hard .difficulty-title { color: #ff6b6b; }
  #skinsMenu button.skin-btn {
    margin: 5px;
    width: 50px; height: 50px;
    border-radius: 50%;
    border: 2px solid #00fff7;
  }
  #skinsMenu button.skin-btn.selected {
    box-shadow: 0 0 15px 3px #00fff7;
  }
  #questsMenu {
    min-width: 350px;
    max-width: 450px;
    max-height: 80vh;
    padding: 30px 32px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  #shopMenu {
    min-width: 350px;
    max-width: 450px;
    max-height: 80vh;
    padding: 30px 32px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  #questList, #shopItems {
    max-height: 60vh;
    overflow-y: auto;
    padding-right: 10px;
    scrollbar-width: thin;
    scrollbar-color: #00fff7 rgba(0,100,150,0.3);
  }
  #questList::-webkit-scrollbar, #shopItems::-webkit-scrollbar {
    width: 8px;
  }
  #questList::-webkit-scrollbar-track, #shopItems::-webkit-scrollbar-track {
    background: rgba(0,100,150,0.3);
    border-radius: 10px;
  }
  #questList::-webkit-scrollbar-thumb, #shopItems::-webkit-scrollbar-thumb {
    background: #00fff7;
    border-radius: 10px;
  }
  #questList::-webkit-scrollbar-thumb:hover, #shopItems::-webkit-scrollbar-thumb:hover {
    background: #73c2e9;
  }
  .quest {
    margin: 16px 0;
    padding: 15px;
    border-radius: 10px;
    background: rgba(0,100,150,0.3);
    font-size: 1.0em;
    box-shadow: 0 0 8px #0ff5;
    transition: all 0.3s;
    border: 2px solid transparent;
  }
  .quest.completed {
    background: rgba(0,200,100,0.28);
    filter: drop-shadow(0 0 8px #7cff7c);
    border-color: #7cff7c;
  }
  .quest-title {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 8px;
    color: #00fff7;
  }
  .quest-progress {
    font-size: 0.9em;
    color: #aaf;
    margin-bottom: 5px;
  }
  .quest-reward {
    font-size: 0.85em;
    color: #ffa500;
    font-style: italic;
  }
  .shop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 16px 0;
    padding: 15px;
    border-radius: 10px;
    background: rgba(0,100,150,0.3);
    font-size: 1.0em;
    box-shadow: 0 0 8px #0ff5;
  }
  .item-details {
    text-align: left;
    flex-grow: 1;
  }
  .item-title {
    font-weight: bold;
    font-size: 1.1em;
    margin-bottom: 5px;
  }
  .item-description {
    font-size: 0.9em;
    color: #aaf;
  }
  .item-price {
    display: flex;
    align-items: center;
    font-weight: bold;
    color: #ffd700;
  }
  .item-price button {
    margin-left: 10px;
  }
  canvas {
    display:block; margin:0 auto;
    background: transparent;
  }
  #flashOverlay {
    position: fixed;
    top:0; left:0; width: 100vw; height: 100vh;
    pointer-events:none;
    background: rgba(255,0,0,0.4);
    display: none;
    mix-blend-mode: screen;
    z-index: 1000;
  }
  #pauseBtn {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(74, 161, 176, 0.7);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 0 10px #4AA1B0;
    z-index: 100;
    display: none;
  }
  #pauseBtn:hover {
    background: rgba(115, 194, 233, 0.7);
    box-shadow: 0 0 14px #73c2e9;
  }
  .power-up-indicator {
    position: fixed;
    bottom: 80px;
    left: 20px;
    display: flex;
    gap: 10px;
  }
  .power-up-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    text-shadow: 0 0 5px black;
  }
  .power-up-icon.active {
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 10px white;
  }
  .power-up-icon.shield { background: rgba(0, 200, 255, 0.7); }
  .power-up-icon.slow { background: rgba(255, 100, 0, 0.7); }
  .power-up-icon.speed { background: rgba(0, 255, 100, 0.7); }
  #difficultyIndicator {
    position: fixed;
    top: 70px;
    right: 20px;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
    background: rgba(0, 0, 0, 0.5);
    box-shadow: 0 0 8px currentColor;
    z-index: 100;
    display: none;
  }
  #difficultyIndicator.easy { color: #7cff7c; }
  #difficultyIndicator.hard { color: #ff6b6b; }
  #adBanner {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 60px;
    background: #191919;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 5000;
    box-shadow: 0 -2px 16px #000a;
  }
  #questNotification {
    position: fixed;
    top: -100px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(45deg, #00fff7, #4AA1B0);
    color: #0a192f;
    padding: 15px 25px;
    border-radius: 10px;
    font-weight: bold;
    font-size: 16px;
    box-shadow: 0 0 20px #00fff7, inset 0 0 20px rgba(255,255,255,0.2);
    z-index: 9999;
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    text-align: center;
    min-width: 300px;
    border: 2px solid #00fff7;
  }
  #questNotification.show {
    top: 20px;
  }
  #questNotification::before {
    content: "";
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, #00fff7, #73c2e9, #4AA1B0, #00fff7);
    border-radius: 10px;
    z-index: -1;
    animation: neonBorder 2s linear infinite;
  }
  @keyframes neonBorder {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
  }
  #shopMenu .coins-display {
    margin-bottom: 20px;
    font-size: 1.5em;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 0 0 10px #ffea00;
  }
</style>
</head>
<body>
<div id="mainContent">
  <div id="info">
    <div id="hearts"></div>
    <div id="time">Time: 0s</div>
    <div id="highScore">High Score: 0s</div>
    <div id="coins">Coins: 0</div>
  </div>
  <div id="difficultyIndicator"></div>
  <div id="questNotification"></div>
  <div id="menu">
    <h1>Boat Racer</h1>
    <button id="playBtn">Play</button><br/>
    <button id="skinsBtn">Skins</button><br/>
    <button id="questsBtn">Quests</button><br/>
    <button id="shopBtn">Shop</button><br/>
  </div>
  <div id="difficultyMenu">
    <h1>Select Difficulty</h1>
    <div class="difficulty-option difficulty-easy" data-difficulty="easy">
      <div class="difficulty-title">Easy Mode</div>
      <div class="difficulty-description">Gentle pace, fewer obstacles - perfect for beginners</div>
    </div>
    <div class="difficulty-option difficulty-hard" data-difficulty="hard">
      <div class="difficulty-title">Hard Mode</div>
      <div class="difficulty-description">High speed, more obstacles - for the true daredevils!</div>
    </div>
    <button id="startGameBtn">Start Game</button>
  </div>
  <div id="skinsMenu">
    <h2>Select Your Boat Skin</h2>
    <div id="skinOptions"></div>
    <button id="skinsBackBtn">Back</button>
  </div>
  <div id="questsMenu">
    <h2>Quests</h2>
    <div id="questList"></div>
    <button id="questsBackBtn">Back</button>
  </div>
  <div id="shopMenu">
    <h2>Shop</h2>
    <div class="coins-display">Your Coins: <span id="shopCoins">0</span></div>
    <div id="shopItems"></div>
    <button id="shopBackBtn">Back</button>
  </div>
  <div id="restartMenu">
    <h1>Game Over!</h1>
    <p id="finalScore">Your Time: 0s</p>
    <p id="bestScore">Best Time: 0s</p>
    <button id="restartBtn">Restart</button><br/>
    <button id="backToMenuBtn">Main Menu</button>
  </div>
  <div id="pauseMenu">
    <h1>Game Paused</h1>
    <button id="continueBtn">Continue</button><br/>
    <button id="pauseToMenuBtn">Main Menu</button>
  </div>
  <div id="flashOverlay"></div>
  <button id="pauseBtn">⏸</button>
  <div class="power-up-indicator">
    <div class="power-up-icon shield" title="Shield">🛡️</div>
    <div class="power-up-icon slow" title="Slow Motion">🐌</div>
    <div class="power-up-icon speed" title="Health Boost">❤️</div>
  </div>
  <canvas id="gameCanvas"></canvas>
</div>

<div id="adBanner">
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-4568215894032054"
       data-ad-slot="1234567890"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  function resize(){
    const adBanner = document.getElementById('adBanner');
    const adHeight = adBanner ? adBanner.offsetHeight : 0;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - adHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  const infoTime = document.getElementById('time');
  const infoHighScore = document.getElementById('highScore');
  const infoCoins = document.getElementById('coins');
  const heartsContainer = document.getElementById('hearts');
  const menu = document.getElementById('menu');
  const playBtn = document.getElementById('playBtn');
  const skinsBtn = document.getElementById('skinsBtn');
  const skinsMenu = document.getElementById('skinsMenu');
  const skinOptionsDiv = document.getElementById('skinOptions');
  const skinsBackBtn = document.getElementById('skinsBackBtn');
  const restartMenu = document.getElementById('restartMenu');
  const finalScoreP = document.getElementById('finalScore');
  const bestScoreP = document.getElementById('bestScore');
  const restartBtn = document.getElementById('restartBtn');
  const backToMenuBtn = document.getElementById('backToMenuBtn');
  const flashOverlay = document.getElementById('flashOverlay');
  const pauseBtn = document.getElementById('pauseBtn');
  const pauseMenu = document.getElementById('pauseMenu');
  const continueBtn = document.getElementById('continueBtn');
  const pauseToMenuBtn = document.getElementById('pauseToMenuBtn');
  const powerUpIndicators = document.querySelectorAll('.power-up-icon');
  const difficultyMenu = document.getElementById('difficultyMenu');
  const startGameBtn = document.getElementById('startGameBtn');
  const difficultyOptions = document.querySelectorAll('.difficulty-option');
  const difficultyIndicator = document.getElementById('difficultyIndicator');
  const questNotification = document.getElementById('questNotification');

  // QUEST System DOM
  const questsBtn = document.getElementById('questsBtn');
  const questsMenu = document.getElementById('questsMenu');
  const questsBackBtn = document.getElementById('questsBackBtn');
  const questList = document.getElementById('questList');

  // NEW: Shop DOM
  const shopBtn = document.getElementById('shopBtn');
  const shopMenu = document.getElementById('shopMenu');
  const shopItemsDiv = document.getElementById('shopItems');
  const shopBackBtn = document.getElementById('shopBackBtn');
  const shopCoinsDisplay = document.getElementById('shopCoins');

  let lives = 3;
  const maxLives = 3;
  let distance = 0;
  let startTime = 0;
  let gameOver = false;
  let obstacles = [];
  let powerUps = [];
  let lastSpawn = 0;
  let spawnInterval = 2500;
  let difficultyIncreaseInterval = 30000;
  let lastDifficultyIncrease = 0;
  let obstacleSpeed = 2.5;
  let maxObstacles = 3;
  let difficulty = 'easy';
  let powerUpSpawnChance = 0.006;
  const powerUpTypeChances = { shield: 0.4, slow: 0.4, speed: 0.2 };
  let flashing = false;
  let flashTime = 0;
  let flashDuration = 300;
  let highScore = 0;
  let gamePaused = false;
  let pauseTime = 0;
  let pauseDuration = 0;
  let hasShield = false;
  let slowMotionActive = false;
  let powerUpEndTime = { slow: 0 };
  const powerUpDuration = 5000;
  
  // NEW: Coin System Variables
  let coins = 0;
  let lastCoinTime = 0;
  let hasStartingShield = false;

  // Game statistics for quests
  let gameStats = {
    totalPowerUps: 0,
    totalGamesPlayed: 0,
    totalObstaclesAvoided: 0,
    perfectRuns: 0, // no damage taken
    longestSurvival: 0,
    hardModeWins: 0,
    shieldsUsed: 0
  };

  // Load game stats and coins
  if(localStorage.getItem("boatRacerStats")){
    gameStats = {...gameStats, ...JSON.parse(localStorage.getItem("boatRacerStats"))};
  }
  if(localStorage.getItem("boatRacerCoins")){
    coins = parseInt(localStorage.getItem("boatRacerCoins"));
  }

  function saveStats(){
    localStorage.setItem("boatRacerStats", JSON.stringify(gameStats));
  }
  
  function saveCoins(){
    localStorage.setItem("boatRacerCoins", coins);
    infoCoins.textContent = `Coins: ${coins}`;
    shopCoinsDisplay.textContent = coins;
  }

  // Enhanced Boat Skins with different shapes and types
  let boatSkins = [
    {color: '#E63946', name: 'Classic Red', type: 'classic'},
    {color: '#457B9D', name: 'Ocean Blue', type: 'classic'},
  ];
  let currentSkinIndex = 0;

  // Shop items now contain all skins
  const shopItems = [
    // Purchasable skins from old list
    { id: 'skin_SunsetOrange', name: 'Sunset Orange', type: 'skin', cost: 1000, skinData: {color: '#F4A261', name: 'Sunset Orange', type: 'classic'} },
    { id: 'skin_RoyalPurple', name: 'Royal Purple', type: 'skin', cost: 1250, skinData: {color: '#6A4C93', name: 'Royal Purple', type: 'classic'} },
    // Quest-based skins now in shop
    { id: 'skin_VictoryRed', name: 'Victory Red', type: 'skin', cost: 1500, skinData: {color: '#ff6b6b', name: 'Victory Red', type: 'speedboat'} },
    { id: 'skin_SurvivorCyan', name: 'Survivor Cyan', type: 'skin', cost: 2000, skinData: {color: '#4ecdc4', name: 'Survivor Cyan', type: 'yacht'} },
    { id: 'skin_CamoWarrior', name: 'Camo Warrior', type: 'skin', cost: 2500, skinData: {color: '#7bbc97', name: 'Camo Warrior', type: 'military'} },
    { id: 'skin_NeonStorm', name: 'Neon Storm', type: 'skin', cost: 3000, skinData: {color: '#39FF14', name: 'Neon Storm', type: 'hovercraft'} },
    { id: 'skin_DodgeMaster', name: 'Dodge Master', type: 'skin', cost: 3500, skinData: {color: '#ffa726', name: 'Dodge Master', type: 'jet'} },
    { id: 'skin_VeteranPurple', name: 'Veteran Purple', type: 'skin', cost: 4000, skinData: {color: '#ab47bc', name: 'Veteran Purple', type: 'cruiser'} },
    { id: 'skin_ElitePink', name: 'Elite Pink', type: 'skin', cost: 4500, skinData: {color: '#e91e63', name: 'Elite Pink', type: 'submarine'} },
    { id: 'skin_GoldenPerfection', name: 'Golden Perfection', type: 'skin', cost: 5000, skinData: {color: '#ffeb3b', name: 'Golden Perfection', type: 'golden'} },
    { id: 'skin_HardcoreOrange', name: 'Hardcore Orange', type: 'skin', cost: 5500, skinData: {color: '#ff5722', name: 'Hardcore Orange', type: 'racer'} },
    { id: 'skin_ShieldMaster', name: 'Shield Master', type: 'skin', cost: 6000, skinData: {color: '#00bcd4', name: 'Shield Master', type: 'armored'} },
    { id: 'skin_TimeLord', name: 'Time Lord', type: 'skin', cost: 6500, skinData: {color: '#9c27b0', name: 'Time Lord', type: 'timeship'} },
    { id: 'skin_ShadowPhantom', name: 'Shadow Phantom', type: 'skin', cost: 7000, skinData: {color: '#212121', name: 'Shadow Phantom', type: 'stealth'} },
    { id: 'skin_PowerCollector', name: 'Power Collector', type: 'skin', cost: 7500, skinData: {color: '#00e676', name: 'Power Collector', type: 'energy'} },
    { id: 'skin_EvasionExpert', name: 'Evasion Expert', type: 'skin', cost: 8000, skinData: {color: '#1de9b6', name: 'Evasion Expert', type: 'phantom'} },
    { id: 'skin_UltimateSurvivor', name: 'Ultimate Survivor', type: 'skin', cost: 8500, skinData: {color: '#f44336', name: 'Ultimate Survivor', type: 'ultimate'} },
    { id: 'skin_MasterSailor', name: 'Master Sailor', type: 'skin', cost: 9000, skinData: {color: '#ff9800', name: 'Master Sailor', type: 'flagship'} },
    { id: 'skin_RainbowLegend', name: 'Rainbow Legend', type: 'skin', cost: 10000, skinData: {color: '#ffffff', name: 'Rainbow Legend', rainbow: true, boatType: 'legendary'} },
    { id: 'skin_GoldPlated', name: 'Gold Plated', type: 'skin', cost: 12000, skinData: {color: '#ffd700', name: 'Gold Plated', type: 'golden'} },
    // Other purchasable items
    { id: 'healthBoost', name: 'Health Boost', desc: 'Instantly restore one life.', cost: 500, type: 'health' },
    { id: 'startShield', name: 'Starting Shield', desc: 'Start your next game with a shield.', cost: 1000, type: 'shield' }
  ];

  // Merge shop skins into boatSkins array and load unlocked status
  shopItems.filter(item => item.type === 'skin').forEach(item => {
    item.skinData.unlocked = false;
    boatSkins.push(item.skinData);
  });

  if(localStorage.getItem("boatRacerSkins")){
    let savedSkins = JSON.parse(localStorage.getItem("boatRacerSkins"));
    savedSkins.forEach(savedSkin => {
        const matchingSkin = boatSkins.find(s => s.name === savedSkin.name);
        if (matchingSkin) {
            matchingSkin.unlocked = savedSkin.unlocked;
        }
    });
  }

  const boat = {
    w: 60,
    h: 90,
    x: 0,
    y: 0,
    speed: 6,
    baseSpeed: 6,
    color: boatSkins[0].color,
    type: boatSkins[0].type || 'classic'
  };

  function resetBoat(){
    boat.x = canvas.width/2 - boat.w/2;
    boat.y = canvas.height - boat.h - 100;
    boat.color = boatSkins[currentSkinIndex].color;
    boat.type = boatSkins[currentSkinIndex].type || 'classic';
    boat.speed = boat.baseSpeed;
  }

  // Enhanced QUEST definitions with more variety - now with coin rewards
  const quests = [
    // Beginner Quests
    { id: 'firstWin', description: "Complete your first game", progress: 0, goal: 1, reward: { type: 'coins', amount: 200 }, completed: false, category: 'beginner' },
    { id: 'survive30', description: "Survive 30 seconds in one run", progress: 0, goal: 30, reward: { type: 'coins', amount: 300 }, completed: false, category: 'survival' },
    { id: 'collect5powerups', description: "Collect 5 power-ups in total", progress: 0, goal: 5, reward: { type: 'coins', amount: 500 }, completed: false, category: 'collection' },
    
    // Intermediate Quests
    { id: 'survive60', description: "Survive 60 seconds in one run", progress: 0, goal: 60, reward: { type: 'coins', amount: 750 }, completed: false, category: 'survival' },
    { id: 'powerup15', description: "Collect 15 power-ups (lifetime)", progress: 0, goal: 15, reward: { type: 'coins', amount: 1000 }, completed: false, category: 'collection' },
    { id: 'avoid50obstacles', description: "Avoid 50 obstacles (lifetime)", progress: 0, goal: 50, reward: { type: 'coins', amount: 1250 }, completed: false, category: 'skill' },
    { id: 'play10games', description: "Complete 10 games total", progress: 0, goal: 10, reward: { type: 'coins', amount: 1500 }, completed: false, category: 'dedication' },
    
    // Advanced Quests  
    { id: 'survive90', description: "Survive 90 seconds in one run", progress: 0, goal: 90, reward: { type: 'coins', amount: 2000 }, completed: false, category: 'survival' },
    { id: 'perfectRun', description: "Complete a game without taking damage", progress: 0, goal: 1, reward: { type: 'coins', amount: 2500 }, completed: false, category: 'skill' },
    { id: 'hardMode30', description: "Survive 30s in Hard Mode", progress: 0, goal: 30, reward: { type: 'coins', amount: 3000 }, completed: false, category: 'challenge' },
    { id: 'shield10times', description: "Use shield power-up 10 times", progress: 0, goal: 10, reward: { type: 'coins', amount: 3500 }, completed: false, category: 'collection' },
    
    // Expert Quests
    { id: 'survive120', description: "Survive 120 seconds (2 minutes!)", progress: 0, goal: 120, reward: { type: 'coins', amount: 4000 }, completed: false, category: 'survival' },
    { id: 'beatBest30', description: "Beat your best score by +30s", progress: 0, goal: 1, reward: { type: 'coins', amount: 5000 }, completed: false, category: 'achievement' },
    { id: 'hardMode60', description: "Survive 60s in Hard Mode", progress: 0, goal: 60, reward: { type: 'coins', amount: 6000 }, completed: false, category: 'challenge' },
    { id: 'powerup50', description: "Collect 50 power-ups (lifetime)", progress: 0, goal: 50, reward: { type: 'coins', amount: 7000 }, completed: false, category: 'collection' },
    
    // Master Quests
    { id: 'avoid200obstacles', description: "Avoid 200 obstacles (lifetime)", progress: 0, goal: 200, reward: { type: 'coins', amount: 8000 }, completed: false, category: 'skill' },
    { id: 'survive180', description: "Survive 180 seconds (3 minutes!)", progress: 0, goal: 180, reward: { type: 'coins', amount: 9000 }, completed: false, category: 'survival' },
    { id: 'play50games', description: "Complete 50 games total", progress: 0, goal: 50, reward: { type: 'coins', amount: 10000 }, completed: false, category: 'dedication' }
  ];

  // Load quest progress
  let questProgress = JSON.parse(localStorage.getItem("boatRacerQuests") || "{}");
  quests.forEach(q=>{
    if(questProgress[q.id]) Object.assign(q, questProgress[q.id]);
  });

  function saveQuests(){
    const data = {};
    quests.forEach(q => data[q.id] = q);
    localStorage.setItem("boatRacerQuests", JSON.stringify(data));
  }
  function saveSkins(){
    localStorage.setItem("boatRacerSkins", JSON.stringify(boatSkins));
  }

  function showQuestNotification(questName, rewardName) {
    questNotification.innerHTML = `
      <div style="font-size: 18px; margin-bottom: 5px;">🎉 QUEST COMPLETE! 🎉</div>
      <div style="font-size: 14px; margin-bottom: 3px;">${questName}</div>
      <div style="font-size: 12px; opacity: 0.9;">💰 Reward: ${rewardName}</div>
    `;
    questNotification.classList.add('show');
    
    setTimeout(() => {
      questNotification.classList.remove('show');
    }, 4000);
  }

  function renderQuests(){
    questList.innerHTML = "";
    
    // Group quests by category
    const categories = {
      'beginner': '🌟 Beginner',
      'survival': '⏱️ Survival',
      'collection': '💎 Collection',
      'skill': '🎯 Skill',
      'dedication': '🏆 Dedication',
      'challenge': '🔥 Challenge',
      'achievement': '👑 Achievement'
    };
    
    Object.entries(categories).forEach(([cat, title]) => {
      const categoryQuests = quests.filter(q => q.category === cat);
      if(categoryQuests.length === 0) return;
      
      const categoryHeader = document.createElement('div');
      categoryHeader.style.cssText = `
        font-size: 1.3em; 
        font-weight: bold; 
        margin: 20px 0 10px 0; 
        color: #00fff7; 
        text-align: center;
        text-shadow: 0 0 10px #00fff7;
        border-bottom: 2px solid #00fff7;
        padding-bottom: 5px;
      `;
      categoryHeader.textContent = title;
      questList.appendChild(categoryHeader);
      
      categoryQuests.forEach(q=>{
        const div = document.createElement('div');
        div.className = `quest${q.completed ? ' completed' : ''}`;
        
        let progText = q.completed ?
          "✅ Completed!" :
          `Progress: ${q.progress}/${q.goal}`;
          
        // Special progress display for certain quest types
        if(!q.completed) {
          if(q.id.includes('survive') && !q.id.includes('total')) {
            progText = "Progress: Complete a run to update";
          } else if(q.id === 'beatBest30') {
            progText = "Progress: Beat your high score by 30s+";
          } else if(q.id === 'perfectRun') {
            progText = "Progress: Complete a flawless run";
          }
        }
        
        let rewardText = `Unspecified Reward`;
        if (q.reward && q.reward.type === 'coins') {
            rewardText = `${q.reward.amount} Coins`;
        }
        
        div.innerHTML = `
          <div class="quest-title">${q.description}</div>
          <div class="quest-progress">${progText}</div>
          <div class="quest-reward">💰 Reward: ${rewardText}</div>
        `;
        questList.appendChild(div);
      });
    });
  }
  
  questsBtn.addEventListener("click", () => {
    renderQuests();
    showQuestsMenu();
  });
  questsBackBtn.addEventListener("click", showMainMenu);

  function showQuestsMenu(){
    menu.style.display = 'none';
    questsMenu.style.display = 'block';
    skinsMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    shopMenu.style.display = 'none';
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
  }

  // Touch input with dragging fix
  let dragging = false;
  let touchOffsetX = 0;

  canvas.addEventListener("touchstart", e => {
    const touch = e.touches[0];
    if (
      touch.clientX >= boat.x &&
      touch.clientX <= boat.x + boat.w &&
      touch.clientY >= boat.y &&
      touch.clientY <= boat.y + boat.h
    ) {
      dragging = true;
      touchOffsetX = touch.clientX - boat.x;
    }
  }, { passive: false });
  canvas.addEventListener("touchmove", e => {
    if (!dragging) return;
    const touch = e.touches[0];
    boat.x = touch.clientX - touchOffsetX;
    boat.x = Math.min(Math.max(0, boat.x), canvas.width - boat.w);
  }, { passive: false });
  canvas.addEventListener("touchend", () => {
    dragging = false;
  });

  // Keyboard control fallback
  let keys = {};
  window.addEventListener('keydown', e => { 
    keys[e.key] = true; 
    if(e.key === 'Escape') togglePause();
  });
  window.addEventListener('keyup', e => { keys[e.key] = false; });

  // Classes for PowerUp and Obstacle
  class PowerUp {
    constructor(type, x, y) {
      this.type = type;
      this.x = x;
      this.y = y;
      this.size = 30;
      this.speed = 2;
      this.collected = false;
      switch(type) {
        case 'shield':
          this.color = '#00a8ff';
          this.symbol = '🛡️';
          break;
        case 'slow':
          this.color = '#fbc531';
          this.symbol = '🐌';
          break;
        case 'speed':
          this.color = '#4cd137';
          this.symbol = '❤️';
          break;
      }
    }
    update() { this.y += this.speed; }
    draw() {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.beginPath();
      ctx.arc(0, 0, this.size/2, 0, Math.PI * 2);
      ctx.fillStyle = this.color;
      ctx.fill();
      ctx.beginPath();
      ctx.arc(0, 0, this.size/2 - 5, 0, Math.PI * 2);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = this.color;
      ctx.fillText(this.symbol, 0, 0);
      ctx.restore();
    }
    getBounds() {
      return {
        x: this.x - this.size/2,
        y: this.y - this.size/2,
        width: this.size,
        height: this.size
      };
    }
    activate() {
      this.collected = true;
      const now = Date.now();
      switch(this.type) {
        case 'shield':
          hasShield = true;
          gameStats.shieldsUsed++;
          updatePowerUpIndicators();
          break;
        case 'slow':
          slowMotionActive = true;
          powerUpEndTime.slow = now + powerUpDuration;
          break;
        case 'speed':
          if (lives < maxLives) {
            lives++;
            updateHearts();
          }
          break;
      }
      updatePowerUpIndicators();
    }
  }

  class Obstacle {
    constructor(x, y, speed){
      this.x = x;
      this.y = y;
      this.speed = speed;
      this.size = 20 + Math.random()*30;
      const shapes = ['circle', 'square', 'triangle'];
      this.shape = shapes[Math.floor(Math.random()*shapes.length)];
      const colors = ['#FFD166', '#06D6A0', '#118AB2', '#EF476F', '#FFC43D', '#8338EC'];
      this.color = colors[Math.floor(Math.random()*colors.length)];
      this.angle = 0;
      this.rotationSpeed = (Math.random() - 0.5) * 0.05;
      this.movementPattern = Math.random() > 0.7 ? (Math.random() > 0.5 ? 'zigzag' : 'following') : 'normal';
      this.zigzagSpeed = Math.random() * 2 + 1;
      this.zigzagDirection = Math.random() > 0.5 ? 1 : -1;
      this.followSpeed = Math.random() * 0.5 + 0.5;
      this.followDelay = Math.random() * 1000 + 500;
      this.followStartTime = Date.now() + this.followDelay;
    }
    update(){
      const effectiveSpeed = slowMotionActive ? this.speed * 0.3 : this.speed;
      this.y += effectiveSpeed;
      this.angle += this.rotationSpeed;
      switch(this.movementPattern) {
        case 'zigzag':
          this.x += this.zigzagSpeed * this.zigzagDirection;
          if(this.x < this.size/2 || this.x > canvas.width - this.size/2) {
            this.zigzagDirection *= -1;
          }
          break;
        case 'following':
          if(Date.now() > this.followStartTime) {
            const dx = boat.x + boat.w/2 - this.x;
            this.x += Math.sign(dx) * this.followSpeed;
          }
          break;
      }
    }
    draw(){
      ctx.fillStyle = this.color;
      ctx.save();
      ctx.translate(this.x, this.y);
      if(this.shape === 'circle'){
        ctx.beginPath();
        ctx.arc(0, 0, this.size/2, 0, 2*Math.PI);
        ctx.fill();
      } else if(this.shape === 'square'){
        ctx.rotate(this.angle);
        ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
      } else if(this.shape === 'triangle'){
        ctx.rotate(this.angle);
        ctx.beginPath();
        ctx.moveTo(0, -this.size/2);
        ctx.lineTo(this.size/2, this.size/2);
        ctx.lineTo(-this.size/2, this.size/2);
        ctx.closePath();
        ctx.fill();
      }
      if(this.movementPattern !== 'normal') {
        ctx.beginPath();
        ctx.arc(0, 0, this.size/2 + 5, 0, Math.PI * 2);
        ctx.strokeStyle = this.movementPattern === 'zigzag' ? '#f39c12' : '#e74c3c';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      ctx.restore();
    }
    getBounds(){
      return {
        x: this.x - this.size/2,
        y: this.y - this.size/2,
        width: this.size,
        height: this.size
      };
    }
  }

  function isCollide(b, o){
    return !(b.x > o.x+o.width || b.x+b.w < o.x || b.y > o.y+o.height || b.y+b.h < o.y);
  }

  function drawBoat(){
    ctx.save();
    ctx.translate(boat.x + boat.w/2, boat.y + boat.h/2);
    const angle = Math.sin(Date.now()/300) * 0.1;
    ctx.rotate(angle);
    if(hasShield) {
      ctx.beginPath();
      ctx.arc(0, 0, Math.max(boat.w, boat.h)/2 + 10, 0, Math.PI * 2);
      ctx.strokeStyle = '#00a8ff';
      ctx.lineWidth = 3;
      ctx.setLineDash([5, 5]);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    
    // Different boat types drawing
    const currentSkin = boatSkins[currentSkinIndex];
    if(currentSkin.rainbow){
      let grad = ctx.createLinearGradient(-boat.w/2, 0, boat.w/2, 0);
      grad.addColorStop(0, "red");
      grad.addColorStop(0.2, "orange");
      grad.addColorStop(0.4, "yellow");
      grad.addColorStop(0.6, "green");
      grad.addColorStop(0.8, "blue");
      grad.addColorStop(1, "purple");
      ctx.fillStyle = grad;
    } else {
      ctx.fillStyle = boat.color;
    }
    
    const boatType = currentSkin.boatType || 'classic';
    
    switch(boatType) {
      case 'speedboat':
        // Sleeker, more angular design
        ctx.beginPath();
        ctx.moveTo(-boat.w/2, boat.h/2);
        ctx.lineTo(-boat.w/4, -boat.h/2 + 5);
        ctx.lineTo(boat.w/4, -boat.h/2 + 5);
        ctx.lineTo(boat.w/2, boat.h/2);
        ctx.lineTo(-boat.w/2, boat.h/2);
        ctx.fill();
        // Add fins
        ctx.fillRect(-boat.w/3, boat.h/3, boat.w/6, boat.h/8);
        ctx.fillRect(boat.w/6, boat.h/3, boat.w/6, boat.h/8);
        break;
      case 'yacht':
        // Wider, more luxurious design
        ctx.beginPath();
        ctx.moveTo(-boat.w/2 - 5, boat.h/2);
        ctx.lineTo(-boat.w/3, -boat.h/2);
        ctx.lineTo(boat.w/3, -boat.h/2);
        ctx.lineTo(boat.w/2 + 5, boat.h/2);
        ctx.closePath();
        ctx.fill();
        // Add deck details
        ctx.fillStyle = '#fff';
        ctx.fillRect(-boat.w/4, -boat.h/4, boat.w/2, boat.h/6);
        break;
      case 'submarine':
        // Cylindrical design
        ctx.beginPath();
        ctx.ellipse(0, 0, boat.w/2, boat.h/2.5, 0, 0, Math.PI * 2);
        ctx.fill();
        // Add periscope
        ctx.strokeStyle = boat.color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(0, -boat.h/2.5);
        ctx.lineTo(0, -boat.h/2 - 10);
        ctx.stroke();
        break;
      case 'hovercraft':
        // Circular base with fan
        ctx.beginPath();
        ctx.ellipse(0, 0, boat.w/2.2, boat.h/2.2, 0, 0, Math.PI * 2);
        ctx.fill();
        // Add fan blades
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        for(let i = 0; i < 6; i++) {
          const angle = (i / 6) * Math.PI * 2;
          ctx.beginPath();
          ctx.moveTo(0, 0);
          ctx.lineTo(Math.cos(angle) * 15, Math.sin(angle) * 15);
          ctx.stroke();
        }
        break;
      default: // classic and others
        ctx.beginPath();
        ctx.moveTo(-boat.w/2, boat.h/2);
        ctx.lineTo(-boat.w/3, -boat.h/2);
        ctx.lineTo(boat.w/3, -boat.h/2);
        ctx.lineTo(boat.w/2, boat.h/2);
        ctx.closePath();
        ctx.fill();
        // Classic boat details
        ctx.strokeStyle = '#00fff7';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(-boat.w/4, boat.h/3);
        ctx.lineTo(boat.w/4, boat.h/3);
        ctx.stroke();
        ctx.fillStyle = '#0ff';
        ctx.fillRect(-boat.w/10, boat.h/6, boat.w/5, boat.h/12);
        break;
    }
    
    ctx.restore();
  }

  function updateHearts(){
    heartsContainer.innerHTML = '';
    for(let i=0; i<maxLives; i++){
      const heart = document.createElement('div');
      heart.classList.add('heart');
      if(i >= lives) heart.classList.add('lost');
      heartsContainer.appendChild(heart);
    }
  }
  function triggerFlash(){
    flashing = true;
    flashTime = Date.now();
    flashOverlay.style.display = 'block';
  }
  function updateFlash(){
    if(flashing && Date.now() - flashTime > flashDuration){
      flashing = false;
      flashOverlay.style.display = 'none';
    }
  }
  function updatePowerUpIndicators() {
    const now = Date.now();
    powerUpIndicators[0].classList.toggle('active', hasShield);
    powerUpIndicators[1].classList.toggle('active', slowMotionActive && now < powerUpEndTime.slow);
    powerUpIndicators[2].classList.toggle('active', false);
  }
  function checkPowerUpExpiration() {
    const now = Date.now();
    if(slowMotionActive && now > powerUpEndTime.slow) {
      slowMotionActive = false;
    }
    updatePowerUpIndicators();
  }
  function spawnPowerUp() {
    if(Math.random() < powerUpSpawnChance && powerUps.length < 1) {
      const rand = Math.random();
      let type;
      if (rand < powerUpTypeChances.shield) type = 'shield';
      else if (rand < powerUpTypeChances.shield + powerUpTypeChances.slow) type = 'slow';
      else type = 'speed';
      const x = Math.random() * (canvas.width - 60) + 30;
      powerUps.push(new PowerUp(type, x, -50));
    }
  }
  function increaseDifficulty() {
    spawnInterval = Math.max(800, spawnInterval - 100);
    obstacleSpeed += 0.3;
    maxObstacles = Math.min(8, maxObstacles + 1);
    powerUpSpawnChance = Math.min(0.015, powerUpSpawnChance + 0.001);
  }

  // PAUSE / RESUME fix for correct pause duration tracking & prevent negative time
  function togglePause(){
    if(gameOver) return;
    if(!gamePaused) {
      // Pausing now
      pauseTime = Date.now();
      gamePaused = true;
      cancelAnimationFrame(animationFrameId);
      pauseMenu.style.display = 'block';
      pauseBtn.textContent = '▶';
    } else {
      // Resuming now
      pauseDuration += (Date.now() - pauseTime);
      pauseTime = 0;
      gamePaused = false;
      pauseMenu.style.display = 'none';
      pauseBtn.textContent = '⏸';
      loop();
    }
  }

  let animationFrameId;
  let gameStartLives = maxLives; // Track starting lives for perfect run
  let coinsGainedThisRun = 0; // NEW: Track coins for this run

  function resetGame(){
    lives = maxLives;
    gameStartLives = maxLives;
    distance = 0;
    startTime = Date.now();
    lastCoinTime = Date.now();
    coinsGainedThisRun = 0;
    gameOver = false;
    obstacles = [];
    powerUps = [];
    lastSpawn = 0;
    lastDifficultyIncrease = 0;
    if (difficulty === 'hard') {
      spawnInterval = 1800;
      obstacleSpeed = 4.0;
      maxObstacles = 5;
      powerUpSpawnChance = 0.008;
      difficultyIndicator.textContent = "HARD MODE";
      difficultyIndicator.className = "hard";
    }
    else {
      spawnInterval = 2500;
      obstacleSpeed = 2.5;
      maxObstacles = 3;
      powerUpSpawnChance = 0.006;
      difficultyIndicator.textContent = "EASY MODE";
      difficultyIndicator.className = "easy";
    }
    difficultyIndicator.style.display = 'block';
    pauseDuration = 0;
    hasShield = hasStartingShield;
    hasStartingShield = false;
    slowMotionActive = false;
    boat.speed = boat.baseSpeed;
    gamePaused = false;
    updatePowerUpIndicators();
    resetBoat();
    updateHearts();
    updateInfo();
  }

  function updateInfo(){
    let elapsed = Math.floor((Date.now() - startTime - pauseDuration) / 1000);
    if(elapsed < 0) elapsed = 0;
    infoTime.textContent = `Time: ${elapsed}s`;
    if(elapsed > highScore) {
      highScore = elapsed;
      localStorage.setItem('boatRacerHighScore', highScore);
    }
    infoHighScore.textContent = `High Score: ${highScore}s`;
    infoCoins.textContent = `Coins: ${coins}`;
  }

  function spawnObstacle(){
    const x = Math.random() * (canvas.width - 60) + 30;
    obstacles.push(new Obstacle(x, -50, obstacleSpeed));
  }

  function update(){
    if(gameOver || gamePaused) return;
    const now = Date.now();
    // NEW: Coin generation based on time
    if(now - lastCoinTime > 2000) {
      coins++;
      saveCoins();
      lastCoinTime = now;
    }
    if(now - lastSpawn > spawnInterval && obstacles.length < maxObstacles){
      lastSpawn = now;
      spawnObstacle();
    }
    spawnPowerUp();
    if(now - lastDifficultyIncrease > difficultyIncreaseInterval){
      lastDifficultyIncrease = now;
      increaseDifficulty();
    }
    obstacles.forEach((o, i) => {
      o.update();
      if(o.y - o.size/2 > canvas.height){
        obstacles.splice(i, 1);
        distance += 100;
        gameStats.totalObstaclesAvoided++;
      } else if(isCollide(boat, o.getBounds())){
        obstacles.splice(i, 1);
        if(hasShield) {
          hasShield = false;
          updatePowerUpIndicators();
        } else {
          lives--;
          updateHearts();
          triggerFlash();
          if(lives <= 0) {
            gameOver = true;
            cancelAnimationFrame(animationFrameId);
            showRestartMenu();
          }
        }
      }
    });
    powerUps.forEach((p, i) => {
      p.update();
      if(p.y - p.size/2 > canvas.height) {
        powerUps.splice(i, 1);
      } else if(!p.collected && isCollide(boat, p.getBounds())) {
        p.activate();
        powerUps.splice(i, 1);
        onPowerupCollected();
      }
    });
    checkPowerUpExpiration();
    // Move boat by keyboard if not dragging
    if (!dragging) {
      if(keys['ArrowLeft'] || keys['a']) boat.x -= boat.speed;
      if(keys['ArrowRight'] || keys['d']) boat.x += boat.speed;
      boat.x = Math.min(Math.max(0, boat.x), canvas.width - boat.w);
    }
    updateFlash();
    updateInfo();
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBoat();
    obstacles.forEach(o => o.draw());
    powerUps.forEach(p => p.draw());
  }

  function loop(){
    update();
    draw();
    if(!gameOver && !gamePaused) animationFrameId = requestAnimationFrame(loop);
  }

  // === FIX: stop game loop on returning to menu to avoid background running ===
  function showMainMenu(){
    gamePaused = true;
    cancelAnimationFrame(animationFrameId);
    menu.style.display = 'block';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    shopMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    flashOverlay.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
    pauseBtn.textContent = '⏸';
  }
  function showSkinsMenu(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'block';
    questsMenu.style.display = 'none';
    shopMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
  }
  function showDifficultyMenu(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'block';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    shopMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
    difficultyOptions.forEach(opt => opt.classList.remove('selected'));
    difficultyOptions[0].classList.add('selected');
    difficulty = 'easy';
  }
  function showRestartMenu(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    shopMenu.style.display = 'none';
    restartMenu.style.display = 'block';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    flashOverlay.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
    const elapsed = Math.floor((Date.now()-startTime - pauseDuration)/1000);
    finalScoreP.textContent = `Your Time: ${elapsed}s`;
    bestScoreP.textContent = `Best Time: ${highScore}s`;
    gameStats.longestSurvival = Math.max(gameStats.longestSurvival, elapsed);
    checkQuestsAtEnd(elapsed);
  }
  function showGameCanvas(){
    menu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    shopMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'block';
    pauseBtn.style.display = 'block';
    difficultyIndicator.style.display = 'block';
  }
  
  // NEW: Shop Functions
  function showShopMenu() {
    menu.style.display = 'none';
    shopMenu.style.display = 'block';
    skinsMenu.style.display = 'none';
    questsMenu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    restartMenu.style.display = 'none';
    pauseMenu.style.display = 'none';
    canvas.style.display = 'none';
    pauseBtn.style.display = 'none';
    difficultyIndicator.style.display = 'none';
    saveCoins(); // Update coin display
    renderShopItems();
  }

  function renderShopItems() {
    shopItemsDiv.innerHTML = "";
    
    shopItems.forEach(item => {
      const div = document.createElement('div');
      div.className = 'shop-item';
      
      const details = document.createElement('div');
      details.className = 'item-details';
      details.innerHTML = `
        <div class="item-title">${item.name}</div>
        <div class="item-description">${item.desc || `Unlock the ${item.name} boat skin.`}</div>
      `;
      div.appendChild(details);
      
      const priceDiv = document.createElement('div');
      priceDiv.className = 'item-price';
      priceDiv.innerHTML = `${item.cost} Coins`;
      
      const buyBtn = document.createElement('button');
      if (item.type === 'skin') {
        const skin = boatSkins.find(s => s.name === item.skinData.name);
        if (skin && skin.unlocked) {
            buyBtn.textContent = "Owned";
            buyBtn.disabled = true;
            div.style.filter = "grayscale(50%)";
        } else {
            buyBtn.textContent = "Buy";
            if (coins < item.cost) {
              buyBtn.disabled = true;
            }
        }
      } else {
        buyBtn.textContent = "Buy";
        if (coins < item.cost) {
          buyBtn.disabled = true;
        }
      }

      buyBtn.addEventListener('click', () => buyItem(item));
      priceDiv.appendChild(buyBtn);
      
      div.appendChild(priceDiv);
      shopItemsDiv.appendChild(div);
    });
  }

  function buyItem(item) {
    if (coins >= item.cost) {
      coins -= item.cost;
      saveCoins();
      
      switch(item.type) {
        case 'health':
          if (lives < maxLives) {
            lives++;
            updateHearts();
            alert("Health Boost purchased! One life has been restored.");
          } else {
            alert("You already have full health!");
            coins += item.cost; // Refund coins
            saveCoins();
          }
          break;
        case 'shield':
          hasStartingShield = true;
          alert("Starting Shield purchased! It will be active at the beginning of your next run.");
          break;
        case 'skin':
          const skinToUnlock = boatSkins.find(s => s.name === item.skinData.name);
          if (skinToUnlock) {
            skinToUnlock.unlocked = true;
            saveSkins();
            alert(`${item.name} skin unlocked! You can now select it in the Skins menu.`);
          }
          break;
      }
      renderShopItems();
    } else {
      alert("Not enough coins!");
    }
  }

  function initSkinButtons(){
    skinOptionsDiv.innerHTML = '';
    boatSkins.forEach((skin, idx) => {
      const btn = document.createElement('button');
      btn.classList.add('skin-btn');
      if(skin.rainbow){
        btn.style.background="linear-gradient(90deg, red, orange, yellow, green, blue, purple)";
      } else {
        btn.style.background = skin.color;
      }
      
      if(idx === currentSkinIndex) btn.classList.add('selected');
      btn.title = skin.name;
      
      const isLocked = skin.unlocked === false;
      if (isLocked) {
        btn.style.filter = "grayscale(100%)";
        const shopItem = shopItems.find(item => item.type === 'skin' && item.skinData.name === skin.name);
        btn.title = `Locked: ${shopItem ? shopItem.cost : '?'} coins`;
      } else {
        btn.addEventListener('click', () => {
          currentSkinIndex = idx;
          skinOptionsDiv.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          boat.color = skin.color;
          resetBoat();
        });
      }
      
      skinOptionsDiv.appendChild(btn);
    });
  }

  playBtn.addEventListener('click', () => {
    showDifficultyMenu();
  });
  difficultyOptions.forEach(option => {
    option.addEventListener('click', () => {
      difficultyOptions.forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
      difficulty = option.dataset.difficulty;
    });
  });
  startGameBtn.addEventListener('click', () => {
    resetGame();
    showGameCanvas();
    loop();
  });
  skinsBtn.addEventListener('click', () => {
    initSkinButtons();
    showSkinsMenu();
  });
  skinsBackBtn.addEventListener('click', () => {
    showMainMenu();
  });
  restartBtn.addEventListener('click', () => {
    resetGame();
    showGameCanvas();
    loop();
  });
  backToMenuBtn.addEventListener('click', () => {
    showMainMenu();
  });
  pauseBtn.addEventListener('click', togglePause);
  continueBtn.addEventListener('click', togglePause);
  pauseToMenuBtn.addEventListener('click', () => {
    togglePause();
    showMainMenu();
  });
  shopBtn.addEventListener('click', showShopMenu);
  shopBackBtn.addEventListener('click', showMainMenu);

  // QUEST SYSTEM tracking and rewards
  function checkQuestsAtEnd(elapsed) {
    gameStats.totalGamesPlayed++;
    
    // Check if it was a perfect run (no damage taken)
    if(lives === gameStartLives) {
      gameStats.perfectRuns++;
    }
    
    // Check hard mode specific achievements
    if(difficulty === 'hard') {
      gameStats.hardModeWins++;
    }
    
    quests.forEach(q => {
      if(q.completed) return;
      
      let questCompleted = false;
      
      switch(q.id) {
        case 'firstWin':
          if(gameStats.totalGamesPlayed >= 1) {
            q.progress = gameStats.totalGamesPlayed;
            questCompleted = true;
          }
          break;
        case 'survive30':
        case 'survive60': 
        case 'survive90':
        case 'survive120':
        case 'survive180':
          const survivalTime = parseInt(q.id.replace('survive', ''));
          if(elapsed >= survivalTime) {
            q.progress = elapsed;
            questCompleted = true;
          }
          break;
        case 'collect5powerups':
        case 'powerup15':
        case 'powerup50':
          q.progress = gameStats.totalPowerUps;
          if(gameStats.totalPowerUps >= q.goal) {
            questCompleted = true;
          }
          break;
        case 'avoid50obstacles':
        case 'avoid200obstacles':
          q.progress = gameStats.totalObstaclesAvoided;
          if(gameStats.totalObstaclesAvoided >= q.goal) {
            questCompleted = true;
          }
          break;
        case 'play10games':
        case 'play50games':
          q.progress = gameStats.totalGamesPlayed;
          if(gameStats.totalGamesPlayed >= q.goal) {
            questCompleted = true;
          }
          break;
        case 'perfectRun':
          if(lives === gameStartLives && elapsed >= 30) {
            q.progress = 1;
            questCompleted = true;
          }
          break;
        case 'hardMode30':
        case 'hardMode60':
          if(difficulty === 'hard') {
            const hardTime = parseInt(q.id.replace('hardMode', ''));
            if(elapsed >= hardTime) {
              q.progress = elapsed;
              questCompleted = true;
            }
          }
          break;
        case 'shield10times':
          q.progress = gameStats.shieldsUsed;
          if(gameStats.shieldsUsed >= q.goal) {
            questCompleted = true;
          }
          break;
        case 'beatBest30':
          const previousBest = parseInt(localStorage.getItem('boatRacerHighScore') || '0');
          if(elapsed >= previousBest + 30 && previousBest > 0) {
            q.progress = 1;
            questCompleted = true;
          }
          break;
      }
      
      if(questCompleted && !q.completed) {
        q.completed = true;
        coins += q.reward.amount;
        saveCoins();
        showQuestNotification(q.description, `${q.reward.amount} Coins`);
      }
    });
    
    saveQuests();
    saveStats();
  }
  
  function onPowerupCollected(){
    gameStats.totalPowerUps++;
    
    // Check power-up related quests immediately
    quests.forEach(q => {
      if(q.completed) return;
      
      if(q.id === 'collect5powerups' || q.id === 'powerup15' || q.id === 'powerup50') {
        q.progress = gameStats.totalPowerUps;
        if(gameStats.totalPowerUps >= q.goal && !q.completed) {
          q.completed = true;
          coins += q.reward.amount;
          saveCoins();
          showQuestNotification(q.description, `${q.reward.amount} Coins`);
        }
      }
    });
    
    saveQuests();
    saveStats();
  }

  // AUTO-PAUSE WHEN TAB OR APP BECOMES HIDDEN
  document.addEventListener('visibilitychange', () => {
    if(document.hidden){
      if(!gamePaused && !gameOver){
        togglePause();
      }
    }
  });

  if(localStorage.getItem('boatRacerHighScore')) {
    highScore = parseInt(localStorage.getItem('boatRacerHighScore'));
    infoHighScore.textContent = `High Score: ${highScore}s`;
  }
  showMainMenu();
})();
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4568215894032054"
     crossorigin="anonymous"></script>
</body>
</html>
